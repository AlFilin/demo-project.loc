class f{constructor(t){if(this.sDefaultWrapperClass="_shopaholic-product-wrapper",this.sWrapperSelector=`.${this.sDefaultWrapperClass}`,this.sPositionIDAttr="data-position-id",this.sOfferIDAttr="offer_id",this.sQuantityAttr="quantity",this.obButton=t,this.obProductCart=t.closest(`${this.sWrapperSelector}`),this.iPositionID=null,this.iOfferID=null,this.iQuantity=1,this.obProperty={},this.iRadix=10,this.eventName="shopaholic.cart.position.extend",!this.obProductCart)throw new Error("Product wrapper is empty. It mast contain product card node");this.referenceType="radio",this.initOfferID(),this.initQuantity(),this.initCartPositionID()}getNode(){return this.obProductCart}getData(){let t={id:this.iPositionID,offer_id:this.iOfferID,quantity:this.iQuantity,property:this.obProperty};return document.dispatchEvent(this.createCustomEvent(t)),t}getPositionID(){return this.iPositionID}getQuantity(){return this.iQuantity}getQuantityInput(){return this.obProductCart.querySelector(`[name=${this.sQuantityAttr}]`)}initOfferID(){const t=this.obProductCart.querySelectorAll(`[name=${this.sOfferIDAttr}]`);if(!t||t.length===0)return;if(this.getOfferIDInputType(t)){const i=[...t].filter(a=>a.checked);this.iOfferID=parseInt(i[0].value,this.iRadix)}else this.iOfferID=parseInt(t[0].value,this.iRadix)}getOfferIDInputType(t){const e=t[0],{type:i}=e;return i===this.referenceType}initQuantity(){const t=this.getQuantityInput();t&&(this.iQuantity=parseInt(t.value,this.iRadix))}initCartPositionID(){const t=this.obProductCart.getAttribute(`${this.sPositionIDAttr}`);t&&(this.iPositionID=parseInt(t,this.iRadix))}createCustomEvent(t){return new CustomEvent(this.eventName,{bubbles:!0,cancelable:!0,detail:t})}}class u{constructor(){this.sOfferItemType="Lovata\\Shopaholic\\Models\\Offer",this.sGetDataHandler="Cart::onGetData",this.iRadix=10,this.sNodeClass="_shopaholic-cart",this.sOldPriceClass="_shopaholic-old-price",this.sHideOldPriceClass="_shopaholic-hide-old-price",this.sGroupAttribute="data-group",this.sFieldAttribute="data-field",this.obCartData=null}static instance(t=null){return window.ShopaholicCart===void 0&&(window.ShopaholicCart=new u,window.ShopaholicCart.init(t)),window.ShopaholicCart}init(t){if(this.obCartData!==null)return;let e={};t&&(e=t),e.complete=({responseJSON:i})=>{this.obCartData=i},oc.ajax(this.sGetDataHandler,e)}updateCartData(t){this.obCartData=t,this.renderPriceFields()}getOfferQuantity(t,e){let i=0;const a=this.findCartPositionByOfferID(t,this.sOfferItemType,e);return a&&(i=a.quantity),parseInt(i,this.iRadix)}getOfferPositionField(t,e){const i=this.findCartPositionByID(t);return i&&i[e]?i[e]:null}getField(t,e){return this.obCartData&&this.obCartData[t]&&this.obCartData[t][e]?this.obCartData[t][e]:null}findCartPositionByOfferID(t,e,i){t=parseInt(t,10);let a=null;if(!this.obCartData||!this.obCartData.position)return;const s=this.obCartData.position,r=Object.keys(s);for(let n of r){let o=s[n];if(!(o.item_id!=t||o.item_type!=e||JSON.stringify(o.property)!=JSON.stringify(i))){a=o;break}}return a}findCartPositionByID(t){t=parseInt(t,10);let e=null;if(console.log("here "+this.obCartData),!this.obCartData||!this.obCartData.position)return;const i=this.obCartData.position;return i[t]?i[t]:e}renderPriceFields(){const t=document.querySelectorAll(`.${this.sNodeClass}`);!t||t.length===0||t.forEach(e=>{const i=e.getAttribute(this.sGroupAttribute),a=i&&i.replace(/-/g,"_").toLowerCase(),s=e.getAttribute(this.sFieldAttribute),r=s&&s.replace(/-/g,"_").toLowerCase();let n="";if(a==="position"){const y=new f(e).getPositionID();n=this.getOfferPositionField(y,r),e.textContent=n}else n=this.getField(a,r),e.textContent=n})}}class g{constructor(){this.sDefaultInputName="shipping_type_id",this.obAjaxRequestCallback=null,this.iRadix=10,this.sComponentMethod="Cart::onSetShippingType",u.instance()}init(){}sendAjaxRequest(t){let i={data:{shipping_type_id:this.getShippingTypeID()},complete:({responseJSON:a})=>{this.completeCallback(a)}};this.obAjaxRequestCallback!==null&&(i=this.obAjaxRequestCallback(i,t)),$.request(this.sComponentMethod,i)}getShippingTypeID(){let t=null;const e=document.querySelectorAll(`[name=${this.sDefaultInputName}]`);if(!e||e.length===0)return t;if(this.getInputType(e)){const a=[...e].filter(s=>s.checked);t=parseInt(a[0].value,this.iRadix)}else t=parseInt(e[0].value,this.iRadix);return t}getInputType(t){const e=t[0],{type:i}=e;return i==="radio"}completeCallback(t){const{data:e}=t;u.instance().updateCartData(e)}setAjaxRequestCallback(t){return this.obAjaxRequestCallback=t,this}}class D{constructor(){this.sDefaultInputClass="_shopaholic-cart-quantity",this.sIncreaseInputClass="_shopaholic-cart-increase-quantity",this.sDecreaseInputClass="_shopaholic-cart-decrease-quantity",this.sUpdateComponentMethod="Cart::onUpdate",this.obAjaxRequestCallback=null,this.iDelayBeforeRequest=400,this.obTimer=null,u.instance()}init(){this.initUpdateEvent(),this.initIncreaseEvent(),this.initDecreaseEvent()}initUpdateEvent(){document.querySelectorAll(`.${this.sDefaultInputClass}`).forEach(t=>{t.addEventListener("input",e=>{this.obTimer!==null&&clearTimeout(this.obTimer),this.obTimer=setTimeout(()=>{let i=this.getQuantity(e.target);const a=this.getMaxQuantity(e.target);i=Math.max(1,Math.min(i,a)),e.target.value=i,this.sendAjaxRequest(e.target)},this.iDelayBeforeRequest)})})}initIncreaseEvent(){document.querySelectorAll(`.${this.sIncreaseInputClass}`).forEach(t=>{t.addEventListener("click",e=>{this.obTimer!==null&&clearTimeout(this.obTimer),this.handleQuantityChange(e.currentTarget,1)})})}initDecreaseEvent(){document.querySelectorAll(`.${this.sDecreaseInputClass}`).forEach(t=>{t.addEventListener("click",e=>{this.obTimer!==null&&clearTimeout(this.obTimer),this.handleQuantityChange(e.currentTarget,-1)})})}handleQuantityChange(t,e){const a=new f(t).getQuantityInput(),s=this.getMaxQuantity(a);let r=this.getQuantity(a);console.log("iQuantity "+r),r=Math.max(1,Math.min(r,s)),a.value=r,this.obTimer=setTimeout(()=>{this.sendAjaxRequest(a)},this.iDelayBeforeRequest)}sendAjaxRequest(t){if(!t)throw new Error("Input node is empty.");let i=new f(t).getData();new g;let s={data:{cart:[i],shipping_type_id:1},complete:({data:r})=>{this.completeCallback(r)},error:(r,n,o)=>{console.error("Error in AJAX Request:",o)}};this.obAjaxRequestCallback!==null&&(s=this.obAjaxRequestCallback(s,t)),oc.ajax(this.sUpdateComponentMethod,s)}getQuantity(t){return parseInt(t.value,10)}getMaxQuantity(t){return parseInt(t.getAttribute("max"),10)}completeCallback(t){let e=JSON.stringify(t),a=JSON.parse(e);console.log(a),u.instance().updateCartData(a)}setAjaxRequestCallback(t){return this.obAjaxRequestCallback=t,this}}new class{constructor(){this.obShopaholicCartUpdate=new D,this.positionNodeSelector="_shopaholic-product-wrapper",this.cardNodeSelector="cart-product",this.restoreHiddenNodeSelector="_visually-hidden",this.restoreNodeSelector="js-item-restore",this.cardHiddenSelector="cart-product_hidden",this.sShippingTypeWrapper="_cart_delivery_wrapper",this.sShippingTypePartial="product/cart/cart-delivery",this.sMiniCartWrapper="_shopaholic-cart-mini-wrapper",this.checkoutBtnSelector="cart-mini-price__checkout",this.checkoutBtnHiddenSelector="cart-mini-price__checkout_hidden",this.payBtnSelector="cart__submit",this.payBtnDisabledSelector="cart__submit_disabled",this.isCartPage=document.body.getAttribute("data-page-id")==="checkout",this.init()}init(){this.initUpdateButton()}initUpdateButton(){this.isCartPage&&this.obShopaholicCartUpdate.setAjaxRequestCallback(t=>(t.update={},t.update[this.sShippingTypePartial]=`.${this.sShippingTypeWrapper}`,t)),this.obShopaholicCartUpdate.init()}changeCartButtonState(t){const{position:e}=t.data,i=Object.keys(e).length===0;let a=document.querySelector(`.${this.checkoutBtnSelector}`),s=this.checkoutBtnHiddenSelector;this.isCartPage&&(a=document.querySelector(`.${this.payBtnSelector}`),a.disabled=i,s=this.payBtnDisabledSelector),i?a.classList.add(s):a.classList.remove(s)}};document.querySelector("#addOrder").addEventListener("click",function(){let l=1,t=1,e=document.getElementById("name").value,i=document.getElementById("phone").value,a=document.getElementById("lastname").value;var s=document.querySelector("._ajax_create_order"),r=document.querySelector(".errorField");document.querySelector(".errorMsg");var n=new Array("user[name]","user[lastname]","user[phone]"),o=new Array("Ваше имя","Фамилия","Номер телефона");let y={order:{payment_method_id:l,shipping_type_id:t},user:{email,name:e,lastName:a,phone:i}};C(s,n,o);function C(h,m,b){var c,d;for(d=0;d<m.length;d++)for(c=0;c<h.length;c++){if(h.elements[c].name==m[d]&&h.elements[c].value=="")return document.querySelector(".errorMsg").style.display="block",console.log("Обнаружил пустые поля"),r.innerHTML="Пожалуйста, введите "+b[d],h[0].animate([{transform:"rotate(0deg)"},{transform:"rotate(0deg)"},{transform:"rotate(5deg)"},{transform:"rotate(-5deg)"},{transform:"rotate(0deg)"}],{duration:100,iterations:2,delay:300}),document.getElementById("loadingmessage").style.display="block",setTimeout(function(){document.getElementById("loadingmessage").style.display="none"},3e3),h.elements[c].focus(),!1;oc.ajax("MakeOrder::onCreate",{data:y,success:function(p){if(p){if(p.X_OCTOBER_REDIRECT)return this.success(p);if(p.status)return this.success(p)}}})}}return!1});document.addEventListener("DOMContentLoaded",()=>{function l(a){let s=a%10,r=a%100;return s===1&&r!==11?"предмет":[2,3,4].includes(s)&&![12,13,14].includes(r)?"предмета":"предметов"}const t=document.querySelector(".countPosition"),e=document.querySelector(".countPositionWord"),i=parseInt(t.textContent)||0;e.textContent=l(i)});
